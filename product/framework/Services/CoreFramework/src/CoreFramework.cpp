#include "CoreFramework.h"

#include <atomic>
#include <ucf/Services/ServiceCommonFile/ServiceLogger.h>
#include <ucf/CoreFramework/IService.h>

namespace ucf{
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
////////////////////Start DataPrivate Logic//////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////

class CoreFramework::DataPrivate
{
public:
    DataPrivate();
    bool isExiting();
    void onExiting();
private:
    std::atomic<bool> mIsExiting;
};

CoreFramework::DataPrivate::DataPrivate()
    : mIsExiting(false)
{
    CORE_LOG_DEBUG("create CoreFramework::DataPrivate, address:" << this);
}

bool CoreFramework::DataPrivate::isExiting()
{
    return mIsExiting.load();
}

void CoreFramework::DataPrivate::onExiting()
{
    mIsExiting.store(true);
}
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
////////////////////Finish DataPrivate Logic//////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
////////////////////Start CoreFramework Logic////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////

std::shared_ptr<ICoreFramework> ICoreFramework::CreateInstance()
{
    return std::make_shared<CoreFramework>();
}

CoreFramework::CoreFramework()
    : mDataPrivate(std::make_unique<CoreFramework::DataPrivate>())
{
    CORE_LOG_DEBUG("create CoreFramework, address:" << this);
}

CoreFramework::~CoreFramework()
{
    CORE_LOG_DEBUG("delete CoreFramework, address:" << this);
}

void CoreFramework::exitCoreFramework()
{
    CORE_LOG_DEBUG("exit CoreFramework, address:" << this);
    mDataPrivate->onExiting();
    fireNotification(&ICoreFrameworkCallback::onCoreFrameworkExit);
    unRegisterServices();
}

std::string CoreFramework::getName() const
{
    return "CoreFramework";
}

void CoreFramework::initServices()
{
    auto allServices = getAllServices();
    std::for_each(allServices.begin(), allServices.end(), [](std::weak_ptr<IService> service){
        if (auto servicePtr = service.lock())
        {
            servicePtr->initService();
        }
    }); 
    fireNotification(&ICoreFrameworkCallback::OnServiceInitialized);
}
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
////////////////////Finish CoreFramework Logic////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
}