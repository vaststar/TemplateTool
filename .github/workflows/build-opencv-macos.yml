name: Build OpenCV for macOS

on:
  workflow_dispatch:
    inputs:
      opencv_version:
        description: 'OpenCV version to build'
        required: true
        default: '4.12.0'
        type: string

env:
  OPENCV_VERSION: ${{ github.event.inputs.opencv_version }}

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-13
            arch: x86_64
            platform_name: intel
          - os: macos-14
            arch: arm64
            platform_name: arm
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          brew update
          brew install cmake ninja
      
      - name: Download OpenCV source
        run: |
          curl -L -o opencv.zip https://github.com/opencv/opencv/archive/refs/tags/${{ env.OPENCV_VERSION }}.zip
          unzip opencv.zip
          mv opencv-${{ env.OPENCV_VERSION }} opencv_src
      
      - name: Configure OpenCV
        run: |
          mkdir -p opencv_build
          cd opencv_build
          cmake ../opencv_src \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_INSTALL_PREFIX=../opencv_install \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_opencv_world=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_python2=OFF \
            -DBUILD_opencv_java=OFF \
            -DWITH_FFMPEG=ON \
            -DWITH_TBB=OFF \
            -DWITH_OPENMP=OFF \
            -DWITH_IPP=OFF \
            -DWITH_CUDA=OFF \
            -DWITH_OPENCL=ON \
            -DWITH_WEBP=ON \
            -DWITH_JPEG=ON \
            -DWITH_PNG=ON \
            -DWITH_TIFF=ON \
            -DWITH_OPENJPEG=ON \
            -DOPENCV_ENABLE_NONFREE=OFF \
            -DOPENCV_GENERATE_PKGCONFIG=ON
      
      - name: Build OpenCV
        run: |
          cd opencv_build
          ninja -j$(sysctl -n hw.ncpu)
      
      - name: Install OpenCV
        run: |
          cd opencv_build
          ninja install
      
      - name: Prepare artifact structure
        run: |
          # Create directory structure matching project layout
          mkdir -p artifact/macosx/${{ matrix.platform_name }}/lib
          mkdir -p artifact/macosx/include
          
          # Copy headers (only once, they're the same for both architectures)
          cp -r opencv_install/include/opencv4/opencv2 artifact/macosx/include/
          
          # Copy libraries
          cp -r opencv_install/lib/*.dylib artifact/macosx/${{ matrix.platform_name }}/lib/
          
          # Copy cmake config files
          mkdir -p artifact/macosx/${{ matrix.platform_name }}/lib/cmake/opencv4
          cp -r opencv_install/lib/cmake/opencv4/* artifact/macosx/${{ matrix.platform_name }}/lib/cmake/opencv4/
          
          # Show what we built
          echo "=== Built libraries ==="
          ls -la artifact/macosx/${{ matrix.platform_name }}/lib/
          
          echo "=== Library info ==="
          file artifact/macosx/${{ matrix.platform_name }}/lib/libopencv_world*.dylib
          
          echo "=== dylib dependencies ==="
          otool -L artifact/macosx/${{ matrix.platform_name }}/lib/libopencv_world*.dylib | head -20
      
      - name: Fix dylib install names
        run: |
          cd artifact/macosx/${{ matrix.platform_name }}/lib
          
          # Get the main world library
          WORLD_LIB=$(ls libopencv_world.*.dylib 2>/dev/null | head -1)
          
          if [ -n "$WORLD_LIB" ]; then
            echo "Fixing install name for $WORLD_LIB"
            
            # Change install name to use @rpath
            install_name_tool -id "@rpath/$WORLD_LIB" "$WORLD_LIB"
            
            echo "=== Updated library info ==="
            otool -L "$WORLD_LIB" | head -5
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-macos-${{ matrix.platform_name }}
          path: artifact/
          retention-days: 30

  merge-artifacts:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Intel artifact
        uses: actions/download-artifact@v4
        with:
          name: opencv-macos-intel
          path: intel/
      
      - name: Download ARM artifact
        uses: actions/download-artifact@v4
        with:
          name: opencv-macos-arm
          path: arm/
      
      - name: Merge artifacts
        run: |
          mkdir -p merged/macosx
          
          # Copy headers (same for both architectures)
          cp -r intel/macosx/include merged/macosx/
          
          # Copy Intel libraries
          cp -r intel/macosx/intel merged/macosx/
          
          # Copy ARM libraries
          cp -r arm/macosx/arm merged/macosx/
          
          echo "=== Final structure ==="
          find merged -type f | head -50
          
          echo ""
          echo "=== Directory structure ==="
          tree merged 2>/dev/null || find merged -type d | sort
      
      - name: Create combined archive
        run: |
          cd merged
          zip -r ../opencv-macos-${{ github.event.inputs.opencv_version }}.zip macosx/
          
          echo "=== Archive contents ==="
          unzip -l ../opencv-macos-${{ github.event.inputs.opencv_version }}.zip | head -30
      
      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-macos-combined
          path: opencv-macos-*.zip
          retention-days: 90
