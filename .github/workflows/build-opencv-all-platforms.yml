name: Build OpenCV All Platforms

on:
  workflow_dispatch:
    inputs:
      opencv_version:
        description: 'OpenCV version to build (e.g., 4.13.0, 4.12.0)'
        required: true
        default: '4.13.0'
        type: string
      platforms:
        description: 'Platforms to build (comma-separated: windows,macos,ios,android,linux)'
        required: true
        default: 'windows,macos,ios,android,linux'
        type: string

env:
  OPENCV_VERSION: ${{ github.event.inputs.opencv_version }}

jobs:
  # ============================================================================
  # Windows Builds (x64, x86, arm64) - Debug and Release
  # ============================================================================
  build-windows:
    if: contains(github.event.inputs.platforms, 'windows')
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            cmake_arch: x64
            msvc_arch: amd64
          - arch: x86
            cmake_arch: Win32
            msvc_arch: amd64_x86
          # ARM64 cross-compilation is complex, skip for now
          # - arch: arm64
          #   cmake_arch: ARM64
          #   msvc_arch: amd64_arm64
    
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}
      
      - name: Download OpenCV source
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/opencv/opencv/archive/refs/tags/${{ env.OPENCV_VERSION }}.zip" -OutFile opencv.zip
          Expand-Archive -Path opencv.zip -DestinationPath .
          Rename-Item -Path "opencv-${{ env.OPENCV_VERSION }}" -NewName "opencv_src"
      
      - name: Configure OpenCV
        shell: cmd
        run: |
          mkdir opencv_build
          cd opencv_build
          cmake ../opencv_src ^
            -G "Visual Studio 17 2022" ^
            -A ${{ matrix.cmake_arch }} ^
            -DCMAKE_INSTALL_PREFIX=../opencv_install ^
            -DBUILD_SHARED_LIBS=ON ^
            -DBUILD_opencv_world=ON ^
            -DBUILD_TESTS=OFF ^
            -DBUILD_PERF_TESTS=OFF ^
            -DBUILD_EXAMPLES=OFF ^
            -DBUILD_DOCS=OFF ^
            -DBUILD_opencv_python3=OFF ^
            -DBUILD_opencv_python2=OFF ^
            -DBUILD_opencv_java=OFF ^
            -DWITH_FFMPEG=ON ^
            -DWITH_CUDA=OFF ^
            -DOPENCV_ENABLE_NONFREE=OFF
      
      - name: Build OpenCV (Release)
        run: cmake --build opencv_build --config Release --parallel
      
      - name: Build OpenCV (Debug)
        run: cmake --build opencv_build --config Debug --parallel
      
      - name: Install OpenCV (Release)
        run: cmake --install opencv_build --config Release
      
      - name: Install OpenCV (Debug)
        run: cmake --install opencv_build --config Debug
      
      - name: Prepare artifact
        shell: pwsh
        run: |
          $arch = "${{ matrix.arch }}"
          
          # Create directory structure
          New-Item -ItemType Directory -Force -Path "artifact/windows/include"
          New-Item -ItemType Directory -Force -Path "artifact/windows/$arch/vc17/bin"
          New-Item -ItemType Directory -Force -Path "artifact/windows/$arch/vc17/lib"
          
          # Find and copy headers
          $includeDir = Get-ChildItem -Path opencv_install -Recurse -Directory -Filter "opencv2" | Select-Object -First 1
          if ($includeDir) {
            Copy-Item -Recurse -Force $includeDir.FullName artifact/windows/include/
          }
          
          # Copy binaries (DLL, PDB)
          Get-ChildItem -Path opencv_install -Recurse -Include "*.dll","*.pdb" | ForEach-Object {
            Copy-Item $_.FullName artifact/windows/$arch/vc17/bin/ -ErrorAction SilentlyContinue
          }
          
          # Copy libraries (LIB)
          Get-ChildItem -Path opencv_install -Recurse -Include "*.lib" | ForEach-Object {
            Copy-Item $_.FullName artifact/windows/$arch/vc17/lib/ -ErrorAction SilentlyContinue
          }
          
          # Copy CMake config
          $cmakeDir = Get-ChildItem -Path opencv_install -Recurse -Directory -Filter "opencv4" | Where-Object { $_.FullName -like "*cmake*" } | Select-Object -First 1
          if ($cmakeDir) {
            New-Item -ItemType Directory -Force -Path "artifact/windows/$arch/vc17/lib/cmake/opencv4"
            Copy-Item -Recurse -Force "$($cmakeDir.FullName)/*" artifact/windows/$arch/vc17/lib/cmake/opencv4/
          }
          
          Write-Host "=== Built files ==="
          Get-ChildItem -Recurse artifact -File | Select-Object FullName
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-windows-${{ matrix.arch }}
          path: artifact/
          retention-days: 30

  # ============================================================================
  # macOS Builds (Intel x86_64, Apple Silicon arm64) - Release only
  # ============================================================================
  build-macos:
    if: contains(github.event.inputs.platforms, 'macos')
    strategy:
      fail-fast: false
      matrix:
        include:
          # macos-13 is retired, use macos-15 with cross-compilation for Intel
          - os: macos-15
            arch: x86_64
            platform_name: intel
          - os: macos-15
            arch: arm64
            platform_name: arm
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: brew install cmake ninja
      
      - name: Download OpenCV source
        run: |
          curl -L -o opencv.zip https://github.com/opencv/opencv/archive/refs/tags/${{ env.OPENCV_VERSION }}.zip
          unzip opencv.zip
          mv opencv-${{ env.OPENCV_VERSION }} opencv_src
      
      - name: Configure OpenCV
        run: |
          mkdir -p opencv_build
          cd opencv_build
          # Disable kleidicv for x86_64 (it's ARM NEON only)
          EXTRA_FLAGS=""
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            EXTRA_FLAGS="-DWITH_KLEIDICV=OFF"
          fi
          
          cmake ../opencv_src \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DCMAKE_INSTALL_PREFIX=../opencv_install \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_opencv_world=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_python2=OFF \
            -DBUILD_opencv_java=OFF \
            -DWITH_FFMPEG=ON \
            -DWITH_CUDA=OFF \
            -DWITH_OPENCL=ON \
            -DOPENCV_ENABLE_NONFREE=OFF \
            $EXTRA_FLAGS
      
      - name: Build OpenCV
        run: cmake --build opencv_build --parallel $(sysctl -n hw.ncpu)
      
      - name: Install OpenCV
        run: cmake --install opencv_build
      
      - name: Prepare artifact
        run: |
          mkdir -p artifact/macosx/include
          mkdir -p artifact/macosx/${{ matrix.platform_name }}/lib
          
          # Copy headers
          cp -r opencv_install/include/opencv4/opencv2 artifact/macosx/include/
          
          # Copy libraries
          cp opencv_install/lib/*.dylib artifact/macosx/${{ matrix.platform_name }}/lib/
          
          # Copy cmake config
          mkdir -p artifact/macosx/${{ matrix.platform_name }}/lib/cmake/opencv4
          cp -r opencv_install/lib/cmake/opencv4/* artifact/macosx/${{ matrix.platform_name }}/lib/cmake/opencv4/
          
          # Fix install names and dependencies to use @rpath
          cd artifact/macosx/${{ matrix.platform_name }}/lib
          for f in *.dylib; do
            if [ -f "$f" ]; then
              # Fix the library's own install name
              install_name_tool -id "@rpath/$f" "$f" 2>/dev/null || true
              
              # Fix dependencies that reference absolute CI runner paths
              otool -L "$f" 2>/dev/null | grep -E "^\s+/" | awk '{print $1}' | while read dep; do
                dep_basename=$(basename "$dep")
                case "$dep" in
                  /Users/runner/*|/home/runner/*)
                    echo "Fixing dependency in $f: $dep -> @rpath/$dep_basename"
                    install_name_tool -change "$dep" "@rpath/$dep_basename" "$f" 2>/dev/null || true
                    ;;
                esac
              done
            fi
          done
          
          # Verify fixes were applied
          echo "=== Verifying dylib dependencies ==="
          for f in *.dylib; do
            if [ -f "$f" ]; then
              echo "--- $f ---"
              otool -L "$f" 2>/dev/null | head -10
            fi
          done
          
          echo "=== Built files ==="
          find ../../../ -type f
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-macos-${{ matrix.platform_name }}
          path: artifact/
          retention-days: 30

  # ============================================================================
  # iOS Build (arm64 device, arm64+x86_64 simulator) - Release only, Static lib
  # ============================================================================
  build-ios:
    if: contains(github.event.inputs.platforms, 'ios')
    runs-on: macos-14
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: brew install cmake
      
      - name: Download OpenCV source
        run: |
          curl -L -o opencv.zip https://github.com/opencv/opencv/archive/refs/tags/${{ env.OPENCV_VERSION }}.zip
          unzip opencv.zip
          mv opencv-${{ env.OPENCV_VERSION }} opencv_src
      
      - name: Build iOS Device (arm64)
        run: |
          mkdir -p build_ios_device
          cd build_ios_device
          cmake ../opencv_src \
            -GXcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphoneos \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_INSTALL_PREFIX=../install_ios_device \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_opencv_world=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_java=OFF \
            -DBUILD_opencv_apps=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_CUDA=OFF \
            -DWITH_OPENCL=OFF \
            -DWITH_IPP=OFF \
            -DWITH_ITT=OFF \
            -DWITH_PROTOBUF=OFF \
            -DWITH_QUIRC=OFF \
            -DENABLE_BITCODE=OFF \
            -DCMAKE_XCODE_ATTRIBUTE_ONLY_ACTIVE_ARCH=NO \
            -DCPU_BASELINE=NEON \
            -DCPU_DISPATCH=NEON
          cmake --build . --config Release -- -quiet
          cmake --install . --config Release
      
      - name: Build iOS Simulator (arm64)
        run: |
          mkdir -p build_ios_sim_arm64
          cd build_ios_sim_arm64
          cmake ../opencv_src \
            -GXcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphonesimulator \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_INSTALL_PREFIX=../install_ios_sim_arm64 \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_opencv_world=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_java=OFF \
            -DBUILD_opencv_apps=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_CUDA=OFF \
            -DWITH_OPENCL=OFF \
            -DWITH_IPP=OFF \
            -DWITH_ITT=OFF \
            -DWITH_PROTOBUF=OFF \
            -DWITH_QUIRC=OFF
          cmake --build . --config Release -- -quiet
          cmake --install . --config Release
      
      - name: Build iOS Simulator (x86_64)
        run: |
          mkdir -p build_ios_sim_x64
          cd build_ios_sim_x64
          cmake ../opencv_src \
            -GXcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_SYSROOT=iphonesimulator \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_INSTALL_PREFIX=../install_ios_sim_x64 \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_opencv_world=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_java=OFF \
            -DBUILD_opencv_apps=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_CUDA=OFF \
            -DWITH_OPENCL=OFF \
            -DWITH_IPP=OFF \
            -DWITH_ITT=OFF \
            -DWITH_PROTOBUF=OFF \
            -DWITH_QUIRC=OFF
          cmake --build . --config Release -- -quiet
          cmake --install . --config Release
      
      - name: Create XCFramework
        run: |
          # Find the static libraries
          DEVICE_LIB=$(find install_ios_device -name "libopencv_world.a" 2>/dev/null | head -1)
          SIM_ARM64_LIB=$(find install_ios_sim_arm64 -name "libopencv_world.a" 2>/dev/null | head -1)
          SIM_X64_LIB=$(find install_ios_sim_x64 -name "libopencv_world.a" 2>/dev/null | head -1)
          
          echo "Device lib: $DEVICE_LIB"
          echo "Sim ARM64 lib: $SIM_ARM64_LIB"
          echo "Sim x64 lib: $SIM_X64_LIB"
          
          mkdir -p artifact/ios/include
          
          # Copy headers
          HEADER_DIR=$(find install_ios_device -type d -name "opencv2" | head -1)
          if [ -n "$HEADER_DIR" ]; then
            cp -r "$HEADER_DIR" artifact/ios/include/
          fi
          
          # Create fat library for simulator (combine arm64 and x86_64)
          if [ -n "$SIM_ARM64_LIB" ] && [ -n "$SIM_X64_LIB" ]; then
            mkdir -p install_ios_sim_fat/lib
            lipo -create "$SIM_ARM64_LIB" "$SIM_X64_LIB" -output install_ios_sim_fat/lib/libopencv_world.a
            SIM_FAT_LIB="install_ios_sim_fat/lib/libopencv_world.a"
          elif [ -n "$SIM_ARM64_LIB" ]; then
            SIM_FAT_LIB="$SIM_ARM64_LIB"
          fi
          
          # Create xcframework
          HEADER_INCLUDE_DIR=$(find install_ios_device -type d -name "include" | head -1)
          if [ -n "$DEVICE_LIB" ] && [ -n "$SIM_FAT_LIB" ] && [ -n "$HEADER_INCLUDE_DIR" ]; then
            xcodebuild -create-xcframework \
              -library "$DEVICE_LIB" \
              -headers "$HEADER_INCLUDE_DIR" \
              -library "$SIM_FAT_LIB" \
              -headers "$HEADER_INCLUDE_DIR" \
              -output artifact/ios/opencv2.xcframework
          elif [ -n "$DEVICE_LIB" ] && [ -n "$SIM_FAT_LIB" ]; then
            xcodebuild -create-xcframework \
              -library "$DEVICE_LIB" \
              -library "$SIM_FAT_LIB" \
              -output artifact/ios/opencv2.xcframework
          elif [ -n "$DEVICE_LIB" ]; then
            # Fallback: just copy device library
            mkdir -p artifact/ios/lib
            cp "$DEVICE_LIB" artifact/ios/lib/
          fi
          
          echo "=== XCFramework structure ==="
          find artifact -type f | head -50
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-ios
          path: artifact/
          retention-days: 30

  # ============================================================================
  # Android Build (arm64-v8a, armeabi-v7a, x86_64, x86) - Release only
  # ============================================================================
  build-android:
    if: contains(github.event.inputs.platforms, 'android')
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86_64, x86]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Android NDK
        uses: android-actions/setup-android@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
      
      - name: Download OpenCV source
        run: |
          curl -L -o opencv.zip https://github.com/opencv/opencv/archive/refs/tags/${{ env.OPENCV_VERSION }}.zip
          unzip opencv.zip
          mv opencv-${{ env.OPENCV_VERSION }} opencv_src
      
      - name: Configure and Build OpenCV
        run: |
          mkdir -p opencv_build
          cd opencv_build
          
          cmake ../opencv_src \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-24 \
            -DANDROID_STL=c++_shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../opencv_install \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_opencv_world=ON \
            -DBUILD_ANDROID_PROJECTS=OFF \
            -DBUILD_ANDROID_EXAMPLES=OFF \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_java=ON \
            -DWITH_FFMPEG=OFF \
            -DWITH_CUDA=OFF \
            -DOPENCV_ENABLE_NONFREE=OFF
          
          cmake --build . --parallel $(nproc)
          cmake --install .
      
      - name: Prepare artifact
        run: |
          ABI=${{ matrix.abi }}
          mkdir -p artifact/android/include
          mkdir -p artifact/android/libs/$ABI
          
          # Copy headers
          HEADER_DIR=$(find opencv_install -type d -name "opencv2" | head -1)
          if [ -n "$HEADER_DIR" ]; then
            cp -r "$HEADER_DIR" artifact/android/include/
          fi
          
          # Copy native libraries (.so files)
          find opencv_install -name "*.so" -exec cp {} artifact/android/libs/$ABI/ \;
          
          # Copy Java libraries if exist
          find opencv_install -name "*.jar" -exec cp {} artifact/android/libs/ \; 2>/dev/null || true
          find opencv_install -name "*.aar" -exec cp {} artifact/android/libs/ \; 2>/dev/null || true
          
          echo "=== Built files ==="
          find artifact -type f
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-android-${{ matrix.abi }}
          path: artifact/
          retention-days: 30

  # ============================================================================
  # Linux Build (x64) - Release only
  # ============================================================================
  build-linux:
    if: contains(github.event.inputs.platforms, 'linux')
    runs-on: ubuntu-22.04  # Use Ubuntu 22.04 for better runner availability
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            libgtk-3-dev \
            libavcodec-dev libavformat-dev libswscale-dev \
            libjpeg-dev libpng-dev libtiff-dev \
            libv4l-dev libxvidcore-dev libx264-dev
      
      - name: Download OpenCV source
        run: |
          curl -L -o opencv.zip https://github.com/opencv/opencv/archive/refs/tags/${{ env.OPENCV_VERSION }}.zip
          unzip opencv.zip
          mv opencv-${{ env.OPENCV_VERSION }} opencv_src
      
      - name: Configure and Build OpenCV
        run: |
          mkdir -p opencv_build
          cd opencv_build
          
          cmake ../opencv_src \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../opencv_install \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_opencv_world=ON \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_python2=OFF \
            -DBUILD_opencv_java=OFF \
            -DWITH_FFMPEG=ON \
            -DWITH_CUDA=OFF \
            -DWITH_GTK=ON \
            -DOPENCV_ENABLE_NONFREE=OFF
          
          cmake --build . --parallel $(nproc)
          cmake --install .
      
      - name: Prepare artifact
        run: |
          mkdir -p artifact/linux/x64/include
          mkdir -p artifact/linux/x64/lib
          
          # Copy headers
          cp -r opencv_install/include/opencv4/opencv2 artifact/linux/x64/include/
          
          # Copy libraries
          cp opencv_install/lib/*.so* artifact/linux/x64/lib/
          
          # Copy cmake config
          mkdir -p artifact/linux/x64/lib/cmake/opencv4
          cp -r opencv_install/lib/cmake/opencv4/* artifact/linux/x64/lib/cmake/opencv4/
          
          echo "=== Built files ==="
          find artifact -type f
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-linux-x64
          path: artifact/
          retention-days: 30

  # ============================================================================
  # Merge All Artifacts into Combined Package
  # ============================================================================
  merge-artifacts:
    needs: [build-windows, build-macos, build-ios, build-android, build-linux]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloads/
      
      - name: Merge artifacts
        run: |
          mkdir -p merged
          
          echo "=== Downloaded artifacts ==="
          ls -la downloads/
          
          # --- Merge Windows ---
          for arch in x64 x86 arm64; do
            if [ -d "downloads/opencv-windows-$arch" ]; then
              echo "Processing Windows $arch..."
              if [ ! -d "merged/windows/include" ]; then
                # First arch: copy everything including headers
                cp -r downloads/opencv-windows-$arch/windows/* merged/windows/ 2>/dev/null || \
                mkdir -p merged/windows && cp -r downloads/opencv-windows-$arch/windows/* merged/windows/
              else
                # Subsequent archs: only copy arch-specific folder
                cp -r downloads/opencv-windows-$arch/windows/$arch merged/windows/
              fi
            fi
          done
          
          # --- Merge macOS ---
          for platform in intel arm; do
            if [ -d "downloads/opencv-macos-$platform" ]; then
              echo "Processing macOS $platform..."
              if [ ! -d "merged/macosx/include" ]; then
                cp -r downloads/opencv-macos-$platform/macosx/* merged/macosx/ 2>/dev/null || \
                mkdir -p merged/macosx && cp -r downloads/opencv-macos-$platform/macosx/* merged/macosx/
              else
                cp -r downloads/opencv-macos-$platform/macosx/$platform merged/macosx/
              fi
            fi
          done
          
          # --- Copy iOS ---
          if [ -d "downloads/opencv-ios" ]; then
            echo "Processing iOS..."
            cp -r downloads/opencv-ios/ios merged/
          fi
          
          # --- Merge Android ---
          for abi in arm64-v8a armeabi-v7a x86_64 x86; do
            if [ -d "downloads/opencv-android-$abi" ]; then
              echo "Processing Android $abi..."
              if [ ! -d "merged/android/include" ]; then
                cp -r downloads/opencv-android-$abi/android/* merged/android/ 2>/dev/null || \
                mkdir -p merged/android && cp -r downloads/opencv-android-$abi/android/* merged/android/
              else
                cp -r downloads/opencv-android-$abi/android/libs/$abi merged/android/libs/
              fi
            fi
          done
          
          # --- Copy Linux ---
          if [ -d "downloads/opencv-linux-x64" ]; then
            echo "Processing Linux..."
            cp -r downloads/opencv-linux-x64/linux merged/
          fi
          
          echo ""
          echo "=== Final structure ==="
          find merged -type d | sort
          echo ""
          echo "=== File count per platform ==="
          for dir in merged/*/; do
            if [ -d "$dir" ]; then
              platform_name=$(basename "$dir")
              file_count=$(find "$dir" -type f | wc -l)
              echo "$platform_name: $file_count files"
            fi
          done
      
      - name: Create archives
        run: |
          VERSION="${{ github.event.inputs.opencv_version }}"
          
          cd merged
          
          # Create per-platform archives
          for platform in */; do
            if [ -d "$platform" ]; then
              platform_name=${platform%/}
              echo "Creating archive for $platform_name..."
              zip -rq "../opencv-${VERSION}-${platform_name}.zip" "$platform_name/"
            fi
          done
          
          # Create combined archive
          cd ..
          zip -rq "opencv-${VERSION}-all-platforms.zip" merged/
          
          echo "=== Created archives ==="
          ls -lh opencv-*.zip
      
      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-all-platforms
          path: opencv-*.zip
          retention-days: 90
